# ローカルLLMの検証報告

## 1. 検証の目的

製造リード日数の問い合わせ対応を自動化するため、ローカル環境で動作するLLMの実用性を検証する。具体的には、受信メールの解析、数値計算、返信メール生成の精度を評価する。

## 2. 検証環境

### ハードウェア構成
| 項目 | 仕様 |
|------|------|
| OS | Windows 11 |
| CPU | AMD Ryzen AI 7 350 |
| RAM | 64GB |
| GPU | NVIDIA GeForce RTX 5070 (VRAM: 8GB) |
| ストレージ | 1TB SSD |

### ソフトウェア構成
| 項目 | 詳細 |
|------|------|
| LLM実行環境 | LM Studio |
| 検証モデル | ・gemma 3n E4b<br>・gpt-oss 20B<br>・gpt-oss 120B |

## 3. モデル起動検証

### 起動可否
| モデル | 起動結果 | 備考 |
|--------|----------|------|
| gemma 3n E4b | 実行可能 | 軽量で起動は安定 |
| gpt-oss 20B | 実行可能 | 8GB VRAMで動作確認 |
| gpt-oss 120B | 起動不可 | VRAM不足により起動できず |

### API経由でのメール本文生成評価
| モデル | 実行可否 | 評価 |
|--------|----------|------|
| gemma 3n E4b | 実行可能 | ・プロンプト指示への追従性が低い<br>・文面がシンプルすぎて単調<br>・**数値計算が絶望的（致命的）** |
| gpt-oss 20B | 実行可能 | ・プロンプト指示への追従性が高い<br>・プロンプトに忠実<br>・数値計算の精度がやや不安定 |

## 4. 検証方法

### 処理フロー
1. 日程担当者からの製造リード日数確認メールを受信
2. AIがメール本文を解析し、必要な数値を抽出
3. リード日数の再計算を実施
4. 整形したメール本文を生成し、元の問い合わせ者へ転送

### 計算ロジック
受信メールから以下の計算を行う：

```
製造LT差分 = 製造LT変更後 - 製造LT変更前
部品在庫ありLT（新） = 部品在庫ありLT（元） + 製造LT差分
部品在庫なしLT（新） = 部品在庫なしLT（元） + 製造LT差分
```

**検証データ例：**
- 製造LT変更前：20 → 変更後：40（差分：+20）
- 部品在庫ありLT（元）：26 → 期待値：46（26 + 20）
- 部品在庫なしLT（元）：132 → 期待値：152（132 + 20）

### 受信メールサンプル
```
お疲れ様です。服部　寛之です。
下記品番の製造LTの確認をお願いいたします。

TPICSから一旦計算してありますので、
それを参考に製造LTと日当たり生産量を返信頂けませんでしょうか。

品番：15160410150

納入LT：1
製造LT：20 ⇒　40
ｾﾂﾀﾞﾝｽﾞﾐｺｰﾄﾞ：5
部品在庫ありLT：26

部品LT(最長) ：106
部品在庫なしLT：132


日当たり生産量：100

ご確認よろしくお願い致します。

----------AI解読用----------
返信先：hiroyuki-hattori@shoeidenko.co.jp
```

- 受信したメールから算出したリード日数を反映したメール本文の生成し日程担当者へ送信


## 5. 検証結果サマリー

### 基本機能の動作確認
| 機能 | 結果 | 備考 |
|------|------|------|
| メール受信 | ✅ 成功 | 正常に受信できることを確認 |
| 返信先アドレス抽出 | ✅ 成功 | "AI解読用"セクションから正確に抽出 |
| 品番の抽出 | ✅ 成功 | メール本文から品番を正確に転記 |
| 製造LT値の認識 | △ 部分的成功 | 値の抽出はできるが計算に課題 |
| 数値計算 | ❌ 不安定 | モデルにより精度に大きな差 |
| メール本文生成 | ✅ 成功 | フォーマットは適切に生成される |

### モデル別の成功率
| モデル | 総合評価 | 成功率 | 主な課題 |
|--------|----------|--------|----------|
| gemma 3n E4b | ❌ 実用不可 | 推定 10%以下 | 数値計算が絶望的 |
| gpt-oss 20B | △ 条件付き可 | **約70%** | 計算精度が不安定（30%は誤計算） |

## 6. 出力例の詳細分析

### 成功例
お疲れ様です。AIメールです。
現場より製造LTの回答がありましたので連絡します。
品番：15160410150
部品在庫ありLT：46
部品在庫なしLT：152
日当たり生産量：100
製造LT変更前：20
製造LT変更後：40
部品在庫ありLT：26
部品在庫なしLT：132
--- 転送用メール ---
いつもお世話になっております。
松栄電工 服部です。
下記品番のリードタイムをご連絡いたします。
【品番】15160410150
部品在庫ありの場合：46日 
部品在庫なしの場合：152日
ご確認のほど、よろしくお願いいたします。
--------------------

### 失敗例
お疲れ様です。AIメールです。
現場より製造LTの回答がありましたので連絡します。
品番：15160410150
部品在庫ありLT：132
部品在庫なしLT：238
日当たり生産量：100
製造LT変更前：20
製造LT変更後：40
部品在庫ありLT：26
部品在庫なしLT：132
--- 転送用メール ---
いつもお世話になっております。
松栄電工 服部です。
下記品番のリードタイムをご連絡いたします。
【品番】15160410150
部品在庫ありの場合：132日 
部品在庫なしの場合：238日
ご確認のほど、よろしくお願いいたします。
--------------------

### 差異分析

| 項目 | 期待値 | 成功例 | 失敗例 | 備考 |
|------|--------|--------|--------|------|
| 部品在庫ありLT | **46日** | 成功 46日 | 失敗 132日 | 失敗例は元の値をそのまま使用 |
| 部品在庫なしLT | **152日** | 成功 152日 | 失敗 238日 | 失敗例は誤った計算を実施 |

**失敗例の問題点：**
- 製造LT差分（+20）を正しく加算できていない
- 部品在庫ありLTは元の値132をそのまま出力（本来は26 + 20 = 46）
- 部品在庫なしLTは誤計算（132 + 106 = 238と推測）

## 7. 課題と考察

### 主な課題
1. **数値計算の不安定性**
   - 単純な加算でも30%の確率で失敗
   - 計算ロジックが推論に依存し、確実性が低い
   
2. **gemmaモデルの実用性**
   - 軽量だが数値計算が致命的に弱い
   - テキスト生成のみの用途に限定される
   
3. **VRAMの制約**
   - 120Bクラスの大規模モデルは8GB VRAMでは動作不可
   - より高性能なハードウェアが必要

### LLMの数値計算に関する一般的知見
- 生成AIは本質的に**テキスト生成に特化**しており、数値計算は苦手
- トークン予測ベースの仕組みでは、算術演算の確実性が保証されない
- 信頼性の高い数値処理には**外部計算ツールとの連携**が推奨される

## 8. 改善提案

### 短期的な対策
1. **プロンプトエンジニアリング**
   - 計算ステップを明示的に指示
   - Few-shotサンプルで計算例を提示
   
2. **検証機構の導入**
   - 出力値の妥当性チェック機能を追加
   - 異常値検出時は人間による確認を要求

### 中長期的な対策
1. **ハイブリッドアプローチ**
   - LLMは情報抽出とテキスト生成に特化
   - 数値計算は従来のプログラムロジックで実装
   - 例：Pythonスクリプトによる計算処理との連携
   
2. **ハードウェア強化**
   - VRAM 16GB以上のGPUへのアップグレード
   - より大規模で高精度なモデルの利用可能性を確保
   
3. **外部APIの検討**
   - Claude/GPT-4などのクラウドAPIの併用
   - 重要な計算処理のみクラウドLLMで実行

## 9. 結論

### 検証結果のまとめ
- ✅ ローカルLLMによるメール自動処理の**基本的な実現可能性を確認**
- ⚠️ 数値計算の精度に課題があり、**現状では完全自動化は困難**
- ✅ gpt-oss 20Bは70%の成功率で、**条件付きで実用可能**

### 推奨される運用方針
1. **段階的導入**: 初期は人間による確認を必須とし、精度向上後に自動化範囲を拡大
2. **ハイブリッド実装**: テキスト処理はLLM、計算処理はプログラムロジックで分担
3. **継続的な検証**: 定期的な精度測定と改善策の実施

